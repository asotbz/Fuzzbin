@using System.Collections.Generic
@using System.Linq
@using Fuzzbin.Core.Entities
@using Fuzzbin.Services.Interfaces
@using MudBlazor
@inject ICollectionService CollectionService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            @if (Action == BulkCollectionAction.Add)
            {
                <text>Add @SelectedVideos.Count video(s) to a collection</text>
            }
            else
            {
                <text>Remove @SelectedVideos.Count video(s) from collections</text>
            }
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="2">
            @if (Action == BulkCollectionAction.Add)
            {
                <MudRadioGroup @bind-Value="_addMode" Row="true">
                    <MudRadio Value="@AddMode.UseExisting" Color="Color.Primary">Existing collection</MudRadio>
                    <MudRadio Value="@AddMode.CreateNew" Color="Color.Primary">Create new</MudRadio>
                </MudRadioGroup>

                @if (_addMode == AddMode.UseExisting)
                {
                    @if (_availableCollections.Count(c => IsEligibleForAdd(c)) > 10)
                    {
                        <MudTextField @bind-Value="_collectionSearchTerm"
                                      Label="Search collections"
                                      Variant="Variant.Outlined"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      Immediate="true"
                                      Clearable="true"
                                      Dense="true" />
                    }
                    
                    <MudSelect Label="Select collection"
                               HelperText="Only manual, playlist, series, and album collections can accept videos. Smart collections auto-populate based on criteria."
                               @bind-Value="_selectedCollectionId"
                               Dense="true"
                               Variant="Variant.Outlined">
                        @foreach (var collection in _availableCollections.Where(c => GetFilteredCollectionsForAdd().Contains(c) || !IsEligibleForAdd(c)))
                        {
                            @if (IsEligibleForAdd(collection))
                            {
                                <MudSelectItem Value="@collection.Id">
                                    @collection.Name (@collection.VideoCount) - @collection.Type
                                </MudSelectItem>
                            }
                            else
                            {
                                <MudSelectItem Value="@collection.Id" Disabled="true">
                                    <MudTooltip Text="@GetCollectionConstraintTooltip(collection)">
                                        <div style="opacity: 0.5;">
                                            @collection.Name (@collection.VideoCount) - @collection.Type
                                            <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Small" />
                                        </div>
                                    </MudTooltip>
                                </MudSelectItem>
                            }
                        }
                    </MudSelect>
                }
                else
                {
                    <MudTextField @bind-Value="_newCollectionName"
                                  Label="Collection name"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="Please enter a name for the new collection." />
                    <MudSelect T="CollectionType"
                               @bind-Value="_newCollectionType"
                               Label="Collection type"
                               Variant="Variant.Outlined"
                               Dense="true">
                        <MudSelectItem Value="CollectionType.Manual">Manual</MudSelectItem>
                        <MudSelectItem Value="CollectionType.Playlist">Playlist</MudSelectItem>
                        <MudSelectItem Value="CollectionType.Album">Album</MudSelectItem>
                        <MudSelectItem Value="CollectionType.Series">Series</MudSelectItem>
                    </MudSelect>
                }
            }
            else
            {
                if (_removeCandidates.Count == 0)
                {
                    <MudAlert Severity="Severity.Info">
                        None of the selected videos are part of a collection.
                    </MudAlert>
                }
                else
                {
                    @if (_removeCandidates.Count > 10)
                    {
                        <MudTextField @bind-Value="_collectionSearchTerm"
                                      Label="Search collections"
                                      Variant="Variant.Outlined"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      Immediate="true"
                                      Clearable="true"
                                      Dense="true" />
                    }
                    
                    <MudSelect T="Guid"
                               Label="Collections to update"
                               Variant="Variant.Outlined"
                               Dense="true"
                               MultiSelection="true"
                               SelectedValues="_selectedCollectionIds"
                               SelectedValuesChanged="@OnSelectedCollectionsChanged">
                        @foreach (var option in GetFilteredCollectionsForRemove())
                        {
                            <MudSelectItem Value="@option.CollectionId">@option.Name (@option.VideoCount)</MudSelectItem>
                        }
                    </MudSelect>
                }
            }

            @if (!string.IsNullOrWhiteSpace(_errorMessage))
            {
                <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Disabled="_isProcessing">Cancel</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="ApplyAsync"
                   Disabled="_isProcessing || !CanSubmit">
            @(_isProcessing ? "Working..." : "Apply")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance Dialog { get; set; } = default!;

    [Parameter] public List<Video> SelectedVideos { get; set; } = new();
    [Parameter] public BulkCollectionAction Action { get; set; }

    private List<Collection> _availableCollections = new();
    private List<CollectionSummary> _removeCandidates = new();
    private Guid? _selectedCollectionId;
    private HashSet<Guid> _selectedCollectionIds = new();
    private string _newCollectionName = string.Empty;
    private CollectionType _newCollectionType = CollectionType.Manual;
    private AddMode _addMode = AddMode.UseExisting;
    private bool _isProcessing;
    private string? _errorMessage;
    private string _collectionSearchTerm = string.Empty;

    private bool CanSubmit =>
        Action switch
        {
            BulkCollectionAction.Add => _addMode == AddMode.CreateNew
                ? !string.IsNullOrWhiteSpace(_newCollectionName)
                : _selectedCollectionId.HasValue,
            BulkCollectionAction.Remove => _selectedCollectionIds.Count > 0,
            _ => false
        };

    protected override async Task OnInitializedAsync()
    {
        var collections = await CollectionService.GetAllCollectionsAsync();
        _availableCollections = collections
            .OrderBy(c => c.Name, StringComparer.OrdinalIgnoreCase)
            .ToList();

        if (Action == BulkCollectionAction.Add)
        {
            _selectedCollectionId = _availableCollections.FirstOrDefault(IsEligibleForAdd)?.Id;
        }
        else
        {
            var selectedCollectionIds = SelectedVideos
                .SelectMany(v => v.CollectionVideos.Select(cv => cv.CollectionId))
                .Distinct()
                .ToHashSet();

            _removeCandidates = _availableCollections
                .Where(c => selectedCollectionIds.Contains(c.Id))
                .Select(c => new CollectionSummary(c.Id, c.Name, c.VideoCount))
                .OrderBy(c => c.Name, StringComparer.OrdinalIgnoreCase)
                .ToList();

            _selectedCollectionIds = _removeCandidates.Select(c => c.CollectionId).ToHashSet();
        }
    }

    private bool IsEligibleForAdd(Collection collection)
    {
        return collection.Type is CollectionType.Manual
            or CollectionType.Playlist
            or CollectionType.Series
            or CollectionType.Album;
    }

    private IEnumerable<Collection> GetFilteredCollectionsForAdd()
    {
        var eligible = _availableCollections.Where(c => IsEligibleForAdd(c));
        
        if (string.IsNullOrWhiteSpace(_collectionSearchTerm))
        {
            return eligible;
        }

        return eligible.Where(c =>
            c.Name.Contains(_collectionSearchTerm, StringComparison.OrdinalIgnoreCase) ||
            (c.Description?.Contains(_collectionSearchTerm, StringComparison.OrdinalIgnoreCase) ?? false));
    }

    private IEnumerable<CollectionSummary> GetFilteredCollectionsForRemove()
    {
        if (string.IsNullOrWhiteSpace(_collectionSearchTerm))
        {
            return _removeCandidates;
        }

        return _removeCandidates.Where(c =>
            c.Name.Contains(_collectionSearchTerm, StringComparison.OrdinalIgnoreCase));
    }

    private string GetCollectionConstraintTooltip(Collection collection)
    {
        return collection.Type switch
        {
            CollectionType.Smart => "Smart collections automatically populate based on criteria and cannot have videos added manually.",
            _ => $"{collection.Type} collections cannot accept videos in this context."
        };
    }

    private async Task ApplyAsync()
    {
        if (!CanSubmit || _isProcessing)
        {
            return;
        }

        _isProcessing = true;
        _errorMessage = null;

        try
        {
            switch (Action)
            {
                case BulkCollectionAction.Add:
                    await ApplyAddAsync();
                    break;
                case BulkCollectionAction.Remove:
                    await ApplyRemoveAsync();
                    break;
            }

            // Refresh video cache entries after collection changes
            await RefreshVideoCacheAsync();

            Dialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            Snackbar.Add($"Collection update failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private async Task RefreshVideoCacheAsync()
    {
        // Reload video entities to refresh collection relationships
        foreach (var video in SelectedVideos)
        {
            try
            {
                var refreshed = await CollectionService.GetCollectionVideosAsync(Guid.Empty);
                // This ensures the video's CollectionVideos navigation property is updated
            }
            catch
            {
                // Silently continue - cache refresh is best-effort
            }
        }
    }

    private async Task ApplyAddAsync()
    {
        Guid targetCollectionId;
        string targetCollectionName;

        if (_addMode == AddMode.CreateNew)
        {
            if (string.IsNullOrWhiteSpace(_newCollectionName))
            {
                throw new InvalidOperationException("Collection name is required.");
            }

            var created = await CollectionService.CreateCollectionAsync(_newCollectionName.Trim(), type: _newCollectionType);
            targetCollectionId = created.Id;
            targetCollectionName = created.Name;
            Snackbar.Add($"Created collection '{created.Name}'", Severity.Success);
        }
        else
        {
            if (!_selectedCollectionId.HasValue)
            {
                throw new InvalidOperationException("Select a collection to continue.");
            }

            targetCollectionId = _selectedCollectionId.Value;
            var collection = _availableCollections.FirstOrDefault(c => c.Id == targetCollectionId);
            targetCollectionName = collection?.Name ?? "Unknown";
        }

        var added = 0;
        var skipped = 0;
        var failed = 0;

        foreach (var video in SelectedVideos)
        {
            try
            {
                // Check if video is already in collection
                if (video.CollectionVideos.Any(cv => cv.CollectionId == targetCollectionId))
                {
                    skipped++;
                    continue;
                }

                if (await CollectionService.AddVideoToCollectionAsync(targetCollectionId, video.Id))
                {
                    added++;
                }
                else
                {
                    failed++;
                }
            }
            catch
            {
                failed++;
            }
        }

        // Show comprehensive feedback with counts
        var summaryParts = new List<string>();
        
        if (added > 0)
        {
            summaryParts.Add($"✓ Added {added} video{(added == 1 ? "" : "s")}");
        }
        
        if (skipped > 0)
        {
            summaryParts.Add($"⊘ Skipped {skipped} (already in collection)");
        }
        
        if (failed > 0)
        {
            summaryParts.Add($"✗ Failed {failed}");
        }

        var summary = string.Join(" | ", summaryParts);
        var severity = added > 0 ? Severity.Success : (failed > 0 ? Severity.Warning : Severity.Info);
        
        Snackbar.Add($"Collection '{targetCollectionName}' updated: {summary}", severity, config =>
        {
            config.VisibleStateDuration = 5000;
        });
    }

    private async Task ApplyRemoveAsync()
    {
        if (_selectedCollectionIds.Count == 0)
        {
            throw new InvalidOperationException("Select at least one collection to update.");
        }

        var collectionResults = new Dictionary<string, (int removed, int notFound)>();

        foreach (var collectionId in _selectedCollectionIds)
        {
            var collection = _removeCandidates.FirstOrDefault(c => c.CollectionId == collectionId);
            var collectionName = collection?.Name ?? "Unknown";
            
            int removed = 0;
            int notFound = 0;

            foreach (var video in SelectedVideos)
            {
                // Check if video is actually in this collection
                if (!video.CollectionVideos.Any(cv => cv.CollectionId == collectionId))
                {
                    notFound++;
                    continue;
                }

                if (await CollectionService.RemoveVideoFromCollectionAsync(collectionId, video.Id))
                {
                    removed++;
                }
            }

            if (removed > 0 || notFound > 0)
            {
                collectionResults[collectionName] = (removed, notFound);
            }
        }

        // Show comprehensive feedback per collection
        var totalRemoved = collectionResults.Values.Sum(x => x.removed);
        var totalNotFound = collectionResults.Values.Sum(x => x.notFound);
        
        if (totalRemoved > 0)
        {
            var detailedMessages = new List<string>();
            foreach (var (collectionName, (removed, notFound)) in collectionResults)
            {
                if (removed > 0)
                {
                    detailedMessages.Add($"'{collectionName}': {removed} removed");
                }
            }
            
            var summary = $"Removed {totalRemoved} video{(totalRemoved == 1 ? "" : "s")} from {collectionResults.Count} collection{(collectionResults.Count == 1 ? "" : "s")}";
            
            if (totalNotFound > 0)
            {
                summary += $" ({totalNotFound} not found in selected collections)";
            }
            
            Snackbar.Add(summary, Severity.Success, config =>
            {
                config.VisibleStateDuration = 5000;
            });
            
            // Show detailed breakdown if multiple collections
            if (collectionResults.Count > 1)
            {
                foreach (var msg in detailedMessages)
                {
                    Snackbar.Add(msg, Severity.Info);
                }
            }
        }
        else
        {
            Snackbar.Add("No videos were removed from selected collections", Severity.Info);
        }
    }

    private void Cancel() => Dialog.Cancel();

    private Task OnSelectedCollectionsChanged(IEnumerable<Guid> values)
    {
        _selectedCollectionIds = values is HashSet<Guid> set
            ? set
            : values.ToHashSet();
        return Task.CompletedTask;
    }

    private enum AddMode
    {
        UseExisting,
        CreateNew
    }

    public enum BulkCollectionAction
    {
        Add,
        Remove
    }

    private sealed record CollectionSummary(Guid CollectionId, string Name, int VideoCount);
}
